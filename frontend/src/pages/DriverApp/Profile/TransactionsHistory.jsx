import React, { useEffect, useMemo, useState } from 'react';
import { getMyTransactionsHistory } from '../../../services/userService';
import './TransactionsHistory.css';

export default function TransactionsHistory() {
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [query, setQuery] = useState({ text: '', status: 'all' });

    useEffect(() => {
        const load = async () => {
            setLoading(true);
            setError('');
            try {
                const result = await getMyTransactionsHistory();
                // Handle response format: could be {data: [...]} or direct array
                const data = result?.data || result || [];
                setItems(Array.isArray(data) ? data : []);
                console.log('‚úÖ Loaded transactions:', data.length);
            } catch (e) {
                console.error('‚ùå Load transactions error:', e);
                setError(e.response?.data?.message || e.message || 'Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ giao d·ªãch');
            } finally {
                setLoading(false);
            }
        };
        load();
    }, []);

    const filtered = useMemo(() => {
        if (!items || items.length === 0) return [];
        return items.filter(x => {
            if (query.status !== 'all' && x.sessionStatus !== query.status) return false;
            if (query.text) {
                const t = query.text.toLowerCase();
                return (
                    String(x.sessionCode || '').toLowerCase().includes(t) ||
                    String(x.stationId || '').includes(t) ||
                    String(x.chargerId || '').includes(t)
                );
            }
            return true;
        });
    }, [items, query]);

    const formatDateTime = (dateTimeStr) => {
        if (!dateTimeStr) return '-';
        try {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch {
            return dateTimeStr;
        }
    };

    const getStatusLabel = (status) => {
        const labels = {
            completed: 'Ho√†n th√†nh',
            charging: 'ƒêang s·∫°c',
            cancelled: 'ƒê√£ h·ªßy',
            failed: 'Th·∫•t b·∫°i',
            pending: 'Ch·ªù x·ª≠ l√Ω'
        };
        return labels[status] || status;
    };

    const getStatusClass = (status) => {
        return `status-badge status-${status}`;
    };

    return (
        <div className="transactions-history-container">
            <div className="transactions-header">
                <h3>L·ªãch s·ª≠ giao d·ªãch</h3>
                <div className="transactions-count">{filtered.length} giao d·ªãch</div>
            </div>

            {error && (
                <div className="error-message">
                    <span className="error-icon">‚ö†Ô∏è</span>
                    {error}
                </div>
            )}

            <div className="filter-row">
                <input
                    type="text"
                    className="search-input"
                    placeholder="üîç T√¨m theo m√£ giao d·ªãch, tr·∫°m s·∫°c..."
                    value={query.text}
                    onChange={e => setQuery({ ...query, text: e.target.value })}
                />
                <select
                    className="status-filter"
                    value={query.status}
                    onChange={e => setQuery({ ...query, status: e.target.value })}
                >
                    <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="completed">Ho√†n th√†nh</option>
                    <option value="charging">ƒêang s·∫°c</option>
                    <option value="cancelled">ƒê√£ h·ªßy</option>
                    <option value="failed">Th·∫•t b·∫°i</option>
                </select>
            </div>

            {loading ? (
                <div className="loading-container">
                    <div className="spinner"></div>
                    <p>ƒêang t·∫£i l·ªãch s·ª≠ giao d·ªãch...</p>
                </div>
            ) : filtered.length === 0 ? (
                <div className="empty-state">
                    <div className="empty-icon">üì≠</div>
                    <p>Kh√¥ng c√≥ giao d·ªãch n√†o</p>
                    <small>{query.text || query.status !== 'all' ? 'Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc' : 'B·∫°n ch∆∞a c√≥ giao d·ªãch s·∫°c n√†o'}</small>
                </div>
            ) : (
                <div className="history-list">
                    {filtered.map(s => (
                        <div key={s.sessionId || s.id} className="history-item">
                            <div className="history-item-header">
                                <div className="session-code">
                                    <span className="code-label">M√£ giao d·ªãch:</span>
                                    <strong>{s.sessionCode || s.id}</strong>
                                </div>
                                <span className={getStatusClass(s.sessionStatus)}>
                                    {getStatusLabel(s.sessionStatus)}
                                </span>
                            </div>

                            <div className="history-item-body">
                                <div className="info-row">
                                    <span className="info-label">üìç Tr·∫°m s·∫°c:</span>
                                    <span>ID {s.stationId}</span>
                                    <span className="separator">‚Ä¢</span>
                                    <span className="info-label">üîå C·ªïng s·∫°c:</span>
                                    <span>ID {s.chargerId}</span>
                                </div>

                                <div className="info-row">
                                    <span className="info-label">üïê B·∫Øt ƒë·∫ßu:</span>
                                    <span>{formatDateTime(s.startTime)}</span>
                                </div>

                                {s.endTime && (
                                    <div className="info-row">
                                        <span className="info-label">üïê K·∫øt th√∫c:</span>
                                        <span>{formatDateTime(s.endTime)}</span>
                                    </div>
                                )}

                                {s.energyConsumed && (
                                    <div className="info-row highlight">
                                        <span className="info-label">‚ö° NƒÉng l∆∞·ª£ng:</span>
                                        <strong>{Number(s.energyConsumed).toFixed(2)} kWh</strong>
                                    </div>
                                )}
                            </div>

                            <div className="history-item-actions">
                                <button
                                    className="btn btn-secondary"
                                    onClick={() => {
                                        const details = {
                                            'M√£ giao d·ªãch': s.sessionCode,
                                            'Tr·∫°m s·∫°c': s.stationId,
                                            'C·ªïng s·∫°c': s.chargerId,
                                            'B·∫Øt ƒë·∫ßu': formatDateTime(s.startTime),
                                            'K·∫øt th√∫c': formatDateTime(s.endTime),
                                            'NƒÉng l∆∞·ª£ng': s.energyConsumed ? `${s.energyConsumed} kWh` : '-',
                                            'Tr·∫°ng th√°i': getStatusLabel(s.sessionStatus)
                                        };
                                        alert(Object.entries(details).map(([k, v]) => `${k}: ${v}`).join('\n'));
                                    }}
                                >
                                    üìÑ Chi ti·∫øt
                                </button>
                                {s.sessionStatus === 'completed' && (
                                    <button
                                        className="btn btn-primary"
                                        onClick={() => alert('T√≠nh nƒÉng xu·∫•t h√≥a ƒë∆°n PDF s·∫Ω ƒë∆∞·ª£c b·ªï sung s·ªõm')}
                                    >
                                        üì• Xu·∫•t h√≥a ƒë∆°n
                                    </button>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}


